<p id="notice"><%= notice %></p>

<h1>Locations</h1>

<div id="<%= @locations.exists? ? 'trackmap2' : ''%>"></div>

<%= content_tag "div", 
  @locations.exists? ? 
  {id: 'trackmap', data: {locations: @locations.select('latitude','longitude')}} : 
  '' do %>
<% end %>

<br>
<div>
<table>
  <thead>
    <tr>
      <th>Logged at</th>
      <th>Latitude</th>
      <th>Longitude</th>
      <th>Run</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% @locations.each do |location| %>
      <tr>
        <td><%= location.logged_at %></td>
        <td><%= location.latitude %></td>
        <td><%= location.longitude %></td>
        <td><%= location.run_id %></td>
        <td><%= link_to 'Show', run_location_path(@run,location) %></td>
        <td><%= link_to 'Edit', edit_run_location_path(@run,location) %></td>
        <td><%= link_to 'Destroy', run_location_path(@run, location), method: :delete, data: { confirm: 'Are you sure?' } %></td>
      </tr>
    <% end %>
  </tbody>
</table>
</div>

<br>

<%= link_to 'New Location', new_run_location_path %> |
<%= link_to 'Show Run', @run %>

<%= javascript_tag do %>
  <% if @locations.exists? %>
    var map = L.map('trackmap');
    L.circle([<%= @locations.first.latitude %>, <%= @locations.first.longitude%>],
          {radius: 3, color: 'Green'}).addTo(map);
    L.circle([<%= @locations.last.latitude %>, <%= @locations.last.longitude%>],
          {radius: 3, color: 'DarkRed'}).addTo(map);

    var latlngs = JSON.parse(document.getElementById('trackmap').dataset.locations).map(c => [c.latitude, c.longitude])
    
    map.setView([0, 0], 15);
    var polyline = L.polyline(latlngs, {weight: 5, color: 'RoyalBlue'}).addTo(map);
    // zoom the map to the polyline
    map.fitBounds(polyline.getBounds());
  <% end %>
<% end %>